<!DOCTYPE html>
<html>
    <head>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <script type='text/javascript' src='knockout-3.5.1.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <style>
            .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
            height: 100px            ;
            width: 100px;
            object-fit: cover;
            }

            .container{

                width: 100%;
                height: 300px;
            }

            .rv-card{

                display: inline-block;
                width:150px;

            }

            .rvname{
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 150px;
                display: flow-root;
            }
        </style>

        <script type="text/javascript">

// Create the script tag, set the appropriate attributes
var script = document.createElement('script');
script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDVHYFCCuN4E5kc292Z1Sub1P5HHpm72eE&callback=initMap';
script.async = true;

let map;

window.map = map;
// Attach your callback function to the `window` object
window.initMap = async function() {
  //@ts-ignore
  const { Map } = await google.maps.importLibrary("maps");

  window.map = new Map(document.getElementById("map"), {
    center: { lat: 49.283356, lng: -123.122115 },
    zoom: 12,
  });

  window.map.addListener("dragend", window.viewmodel.searchRv);

};

// Append the 'script' element to 'head'
document.head.appendChild(script);
        </script>
    </head>

    <body >

        <!-- <p>First name: <input data-bind="value: firstName" /></p>
        <p>Last name: <input data-bind="value: lastName" /></p> -->

        <div id="map" class="container"></div>

        <input type="button" data-bind="click: searchRv" value="Search" />


        <div data-bind="foreach: featuredRVs, visible: featuredRVs().length > 0" >
            <div class="rv-card">
                <label data-bind="text: RVName" class="rvname"></label><br />
                <div style="width:150px;height:150px;display:inline-block;">
                    <img class="center" data-bind="attr:{src: 'https://cdn-d.rvezy.com/450x300x80' +  Photos[0].Path}" />  
                </div>

            </div>

        </div>



<script type="text/javascript">

    function AppViewModel() {
        // this.firstName = ko.observable("Bert");
        // this.lastName = ko.observable("Bertington");

        this.dragEnd = function(event) {

            //console.log('dragend', window.map.center.lat(), window.map.center.lng());
            //console.log('map', window.map);
            //document.getElementById('lat').value = event.latLng.lat();
            //document.getElementById('lng').value = event.latLng.lng();

            
        }

        window.viewmodel = this;


        this.featuredRVs = ko.observableArray([]);

        this.markers = [];

        this.searchRv = async function(){
            try {
                window.viewmodel.isLoadingData = true

                //SearchLat=49.26432&SearchLng=-123.09607
                const response = await axios.get(`https://api.rvezy.com/api/rvlistings/unified-search?SearchLat=${window.map.center.lat()}&SearchLng=${window.map.center.lng()}&SortOrder=Recommended&CurrentPage=0&FeaturedCurrentPage=0&FeaturedPageSize=5&IncludeFeatured=true`);
                const FeaturedRVs = response?.data?.FeaturedRVs?.ListRVs
                const PopularRVs = response?.data?.PopularRVs?.ListRVs

                window.viewmodel.featuredRVs.removeAll();
                
                window.viewmodel.markers.forEach(function(marker){
                    try{
                        marker.setMap(null);
                    } catch {}
                }, window.viewmodel);

                //window.viewmodel.markers = [];

                FeaturedRVs.forEach(function(rv){
                    //rv.RVName = ko.observable(rv.RVName);
                    rv.Photos[0].Path = rv.Photos[0].Path.replace('.jpg', '.webp');
//p.replace('dog', 'monkey')
                    this.featuredRVs.push(rv);

                    var myLatLng = { lat: rv.Latitude, lng: rv.Longitude };

                    var marker = {
                        position: myLatLng,
                        map: window.map,
                        title: "Hello World!",
                    };

                    var m = new google.maps.Marker(marker);
                    window.viewmodel.markers.push(m);

                }, window.viewmodel);
                
                console.log('response', response);
            } catch (error) {
                console.log(error);
            } finally
            {
                window.viewmodel.isLoadingData = false
            }
        }
    }
    
    // Activates knockout.js
    ko.applyBindings(new AppViewModel());
</script>

    </body>
</html>